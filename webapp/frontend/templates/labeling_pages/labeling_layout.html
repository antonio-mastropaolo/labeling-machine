{% extends "common_pages/common_layout.html" %}

{% block headerStuff %}
    <link href="https://cdn.jsdelivr.net/npm/highlightjs-themes@1.0.0/androidstudio.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
    <link href="{{ url_for('static', filename='css/artifact_common.css') }}" rel="stylesheet" type="text/css">
    <link href="{{ url_for('static', filename='css/page_layout.css') }}" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlightjs-themes@1.0.0/github.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/highlight.min.js"></script>

    <script src="{{ url_for('static', filename='js/jquery.lettering-0.6.1.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/common-function.js') }}"></script>
    <script src="{{ url_for('static', filename='js/rangy-1.3.0/rangy-core.js') }}"></script>
    <script src="{{ url_for('static', filename='js/rangy-1.3.0/rangy-serializer.js') }}"></script>

{% endblock %}

<!-- Bootstrap container -->
 <div class="container">

    {% block content %}

        <div class="row no-gutters" style="background-color: black; padding-top: 10px;">

                 <div class=" col-md-4">
                    <div class="text-left">
                        <button class="btn btn-outline-info"
                            type="submit"
                            id="next-skip-btn"
                            onclick="skip_next_artifact()"
                            style="width: 100%;"> Skip
                        </button>
                    </div>

                 </div>

            <div class=" col-md-4">
                <div id="progress-bar" style="text-align: center; font-size: medium; color: white;">
                    {{ overall_labeling_status['n_artifacts_labeled_and_reviewed'] }}
                    out of
                  {{ overall_labeling_status['n_total_artifacts'] }}
                </div>
                <div class="justify-content-center" style="display: flex;">
                    <div class="progress" style="width:50%;">
                        <div id="top-progress-bar-status" class="progress-bar" role="progressbar" style="width: 0%;"
                             aria-valuenow="0"
                             aria-valuemin="0"
                             aria-valuemax="100">
                        </div>
                    </div>
                </div>
            </div>

            <div class=" col-md-4">
                <div class="text-right">
                    <button class="btn btn-outline-success"
                            type="submit"
                            id="next-skip-btn"
                            onclick="submitClassification();"
                            style="width: 100%;"> Submit Classification
                    </button>
                </div>

            </div>

        </div>

        <div class="row no-gutters" style="background-color: black; height: 15px;">

            <div class=" col-md-12">
                <div class="" style="position: relative; padding-left: 20px;"></div>
            </div>

        </div>


        <div class="row no-gutters">

              <div class=" col-md-2 vh-100" style="background-color: black;">
                  <div id="categoriesColumn" >
                          <div class="buttonWrapper">
                              <button class="btn btn btn-dark category-button"
                                type="submit"
                                id="code-summary-button"
                                style="width: 100%" > Code Summary
                              </button>
                          </div>

                          <div class="buttonWrapper">
                              <button class="btn btn btn-dark category-button"
                                type="submit"
                                id="expand-button"
                                style="width: 100%" > Expand
                              </button>
                          </div>

                          <div class="buttonWrapper">
                              <button class="btn btn btn-dark category-button"
                                type="submit"
                                id="rationale-button"
                                style="width: 100%" > Rationale
                              </button>
                          </div>

                          <div class="buttonWrapper">
                              <button class="btn btn btn-dark category-button"
                                type="submit"
                                id="deprecation-button"
                                style="width: 100%" > Code Deprecation
                              </button>
                          </div>

                          <!--<div class="buttonWrapper">
                              <button class="btn btn btn-dark category-button"
                                type="submit"
                                id="usage-button"
                                style="width: 100%" > Usage
                              </button>
                          </div>
                          We decided to discard this comment category since too fine-grained
                          -->

                          <!--
                          <div class="buttonWrapper">
                              <button class="btn btn btn-dark category-button"
                                type="submit"
                                id="exception-button"
                                style="width: 100%" > Exception
                              </button>
                          </div>
                          We decided to discard this comment category since too fine-grained
                          -->

                           <div class="buttonWrapper">
                              <button class="btn btn btn-dark category-button"
                                type="submit"
                                id="todo-button"
                                style="width: 100%" > Work in Progress <!-- Previously: TO-DO -->
                              </button>
                          </div>

                           <div class="buttonWrapper">
                              <button class="btn btn btn-dark category-button"
                                type="submit"
                                id="comment-code-button"
                                style="width: 100%" > Commented Code
                              </button>
                          </div>

                          <div class="buttonWrapper">
                              <button class="btn btn btn-dark category-button"
                                type="submit"
                                id="incomplete-button"
                                style="width: 100%" > Incomplete Comment
                              </button>
                          </div>

                          <div class="buttonWrapper">
                              <button class="btn btn btn-dark category-button"
                                type="submit"
                                id="new-category-button1"
                                style="width: 100%" > Define new category
                              </button>
                          </div>
                  </div>
                  <hr class="solid" style="position:relative; top:-15px;" id="topLevelLineSep">

                  <hr class="solid" style="position:sticky; top:90.2%;">
                  <div id='refreshButton' style="position:fixed; left:11%; top:92%;" onclick="window.location.reload();">
                          <i class="far fa-trash-alt fa-4x" style="color:white;"></i>
                  </div>
                  <div id="toggleButton" style="position:fixed; left:2.0%; top:92%;">
                      <i class="fas fa-info-circle fa-4x" style="color:white;"></i>
                  </div>

              </div>


            <div class=" col-md-8 overflow-auto" id="codeColumn" style="height: 84.5vh;">

                <div class="row-column">

                    <pre id="rows-wrapper" class="rows">
                        <code id="rows" class="lang-java" style="display:inline; float:left; overflow: scroll;"></code>
                        <code id="code" class="lang-java">{{ artifact_class }}</code>
                    </pre>

                </div>

            </div>


            <div class=" col-md-2 no-float" id="methodsLabel" style="background-color: black;">

                <div id="upperSide" style="height: 40%;  position: absolute; width:100%; float:left; overflow-y: scroll;">
                    <!-- This Div is dyamically filled -->
                </div>

                <div id="divider" style="position: relative; top:38%; z-index:1000;">
                     <hr class="solid">
                         <div style="text-align: center; color: white;">
                             <h4 style="width:100%; position:relative;">ASSOCIATIONS</h4>
                             <span id="badgeCounter" class="badge badge-secondary" style="font-size:20px;">0</span>
                         </div>
                    <hr class="solid">
                </div>
                 <div id="lowerSide" style="height: 50%;  overflow-y: scroll; position:sticky;  top:90%; width:100%; float: left;">

                </div>
            </div>

        </div>

        <div class="row no-gutters">
            <div class=" col-md-2"></div>
            <div class=" col-md-8">
                <div contenteditable="true" id="textAreaSelectedText" rows="4" cols="50" class="textarea"></div>
                <button id="clearText" style="color:white;" type="submit" class='btn btn-dark button-corner-down' onclick="reset(); resetClicked=true;">Clear</button>
                <button id="saveClassification" type="submit" class='btn btn-dark button-corner-up' onclick="saveCategorization(); resetClicked=true;">Save</button>
            </div>
            <div class=" col-md-2"></div>
        </div>

    {% endblock %}



 </div>


{% block scriptsStuff %}

    <script>

        // -------------------------Start-------------------------

        hljs.highlightAll();


        //updating progress bar
        var labelProgressPercentage = {{ overall_labeling_status['n_artifacts_labeled'] }}*100 / {{ overall_labeling_status['n_total_artifacts'] }};
        labelProgressPercentage = Math.ceil(labelProgressPercentage);
        document.getElementById("top-progress-bar-status").style.width = labelProgressPercentage + '%';
        document.getElementById("top-progress-bar-status").innerHTML = labelProgressPercentage + '%';

        const methodsList = {{ artifact_methodsListLines | tojson }};
        const methodsListNames = {{ artificat_methodsName | safe }};
        const linesList = {{ artificat_lines | tojson }};
        const isLabeled = {{ isLabeled }};
        const isReviewed = {{ isReviewed }};
        const workingMode = (isLabeled == 0 ? 0  : 1);

        var startTime = new Date().getTime();

        var labelCategories = ["new-category-button1",
                                'expand-button',
                                'rationale-button',
                                'deprecation-button',
                                'usage-button',
                                'exception-button',
                                'todo-button',
                                'code-summary-button',
                                'comment-code-button',
                                'incomplete-button',
        ];

        var selectedCategory = "";
        var selectedCodeText = "";
        var selectedCommentText = "";
        var counterAssociations = 0;
        var currentIndexComment = -1;
        var dictIndex = 0;
        var whereCommentBegin = -1;
        var whereCommentEnd = -1;
        var resetClicked=false;
        var clicked = false;
        var currentClassification=-1;
        var defaultColorHighlight='red';
        var flagSwitch=true;
        var changingToClassificationOnGoing=false;

        var commentEleToHighlight = [];
        var highlightedCommentsInReviewing = [];

        var dictHighlightedCode = {};
        var dictHighlightedComments = {};
        var dictHighlightedCommentsPosition = {};
        //var dictRangeHighlightedCode = {};
        var dictHighlightedCommentsCharacterPosition = {};
        var dictHighlightedCodeCharacterPosition = {};
        var dictSelectedCategories = {};
        var dictSelectedCode = {};
        var dictSelectedComment = {};


        var comments = []; //In this list we store all the comments within a given class
        var selectedComments = [];
        var selectedCode = [];
        var serializedRangeList = []
        var listSelectedSpanCode = [];
        var listSelectedSpanComment = [];
        var selectedCategories = [];
        var commentsToHighlight = [];
        var methodSelectionButton = [];
        var moveSelectionButtonList = [];
        var highlightedCodeDuringSelection = []
        var commentIndex = [];
        var beginningCommentCharacterPosition = -1
        var endCommentCharacterPosition = -1

        // -------------------------End-------------------------

        $(document).ready(function () {


            $("h1").css('color', 'white');
            $("h2").css('color', 'white');
            $('.hljs-comment').css('user-select', 'none');

            // Filling up lines column
            for (var i = 0; i < linesList.length; i++) {
                linesList[i] = linesList[i] + 1
                var newButton = '<div style="width:100%;" class="row-line">' + linesList[i] + '</div>';
                $("#rows").append($(newButton));
            }

            for (var i = 0; i < methodsList.length; i++) {
                var buttonID = methodsListNames[i] + "-button";
                var startingLine = methodsList[i].split("-")[0];
                var buttonText = methodsListNames[i];// + " " +startingLine + '---' + endingLine;
                var scorllCall = 'moveToSelectedMethodFromLine(' + startingLine + ')';
                var newButton = '<div class="buttonWrapper style="display: flex; flex-direction:row;"> <button class="btn btn btn-dark" type="submit" id="' + buttonID + '" onclick="' + scorllCall + '" style="width: 100%; display:inline-flex; text-align: left;">' + buttonText + '</button> </div>';
                //console.log(newButton);
                $("#upperSide").append($(newButton));
            }

            comments = document.getElementsByClassName("hljs-comment");

            if (isLabeled == 0) {
                for(var i=0;i<100;i++) {
                    dictHighlightedCode[i] = [];
                    dictHighlightedCommentsPosition[i] = [];
                    dictHighlightedCommentsCharacterPosition[i] = [];
                    dictHighlightedCodeCharacterPosition[i] = [];
                    dictSelectedCategories[i] = [];
                    dictSelectedCode[i] = [];
                    dictSelectedComment[i] = [];
                }
            }

            $("#refreshButton").mouseenter(function() {
                    var myDiv = document.createElement('div');
                    myDiv.setAttribute('class', 'popUp');
                    myDiv.setAttribute('id', 'popUpRefresh');
                    myDiv.innerHTML = 'Remove all classifications!';
                    document.body.appendChild(myDiv);
                }
            );

            $("#refreshButton").mouseleave(function() {
                    $("#popUpRefresh").remove();
                }
            );

            $("#toggleButton").mouseenter(function() {
                    var myDiv = document.createElement('div');
                    myDiv.setAttribute('class', 'popUp');
                    myDiv.setAttribute('id', 'popUpToggle');
                    myDiv.innerHTML = 'Flag this class for further inspections';
                    document.body.appendChild(myDiv);
                }
            );

            $("#toggleButton").mouseleave(function() {
                    $("#popUpToggle").remove();
                }
            );

            /* Handling hoover for the category section */

            //******************* Code summary **********************
             $("#code-summary-button").mouseenter(function() {
                    var myDiv = document.createElement('div');
                    myDiv.setAttribute('class', 'popUpCategory');
                    myDiv.setAttribute('id', 'pop-up-cs');
                    myDiv.innerHTML = 'The comment is a high-level summary for the code';
                    document.body.appendChild(myDiv);
                }
            );

            $("#code-summary-button").mouseleave(function() {
                    $("#pop-up-cs").remove();
                }
            );

            //******************* Expand **********************
            $("#expand-button").mouseenter(function() {
                    var myDiv = document.createElement('div');
                    myDiv.setAttribute('class', 'popUpCategory');
                    myDiv.setAttribute('id', 'pop-up-expand');
                    myDiv.innerHTML = 'A verbose description of the implementation';
                    document.body.appendChild(myDiv);
                }
            );

            $("#expand-button").mouseleave(function() {
                    $("#pop-up-expand").remove();
                }
            );

            //******************* Rationale **********************
            $("#rationale-button").mouseenter(function() {
                    var myDiv = document.createElement('div');
                    myDiv.setAttribute('class', 'popUpCategory');
                    myDiv.setAttribute('id', 'pop-up-rationale');
                    myDiv.innerHTML = 'The comment answers the question (WHY?)';
                    document.body.appendChild(myDiv);
                }
            );

            $("#rationale-button").mouseleave(function() {
                    $("#pop-up-rationale").remove();
                }
            );

            //******************* Deprecation **********************
            $("#deprecation-button").mouseenter(function() {
                    var myDiv = document.createElement('div');
                    myDiv.setAttribute('class', 'popUpCategory');
                    myDiv.setAttribute('id', 'pop-up-deprecation');
                    myDiv.innerHTML = 'The code is deprecated';
                    document.body.appendChild(myDiv);
                }
            );

            $("#deprecation-button").mouseleave(function() {
                    $("#pop-up-deprecation").remove();
                }
            );

            //******************* Usage **********************
            $("#usage-button").mouseenter(function() {
                    var myDiv = document.createElement('div');
                    myDiv.setAttribute('class', 'popUpCategory');
                    myDiv.setAttribute('id', 'pop-up-usage');
                    myDiv.innerHTML = '.......!';
                    document.body.appendChild(myDiv);
                }
            );

            $("#usage-button").mouseleave(function() {
                    $("#pop-up-usage").remove();
                }
            );

            //******************* Exception **********************
            $("#exception-button").mouseenter(function() {
                    var myDiv = document.createElement('div');
                    myDiv.setAttribute('class', 'popUpCategory');
                    myDiv.setAttribute('id', 'pop-up-exception');
                    myDiv.innerHTML = '.......!';
                    document.body.appendChild(myDiv);
                }
            );

            $("#exception-button").mouseleave(function() {
                    $("#pop-up-exception").remove();
                }
            );

            //******************* TO-DO **********************
             $("#todo-button").mouseenter(function() {
                    var myDiv = document.createElement('div');
                    myDiv.setAttribute('class', 'popUpCategory');
                    myDiv.setAttribute('id', 'pop-up-todo');
                    myDiv.innerHTML = 'The comment is complete but the code is not fully developed';
                    document.body.appendChild(myDiv);
                }
            );

            $("#todo-button").mouseleave(function() {
                    $("#pop-up-todo").remove();
                }
            );

            //******************* Commented Code **********************
             $("#comment-code-button").mouseenter(function() {
                    var myDiv = document.createElement('div');
                    myDiv.setAttribute('class', 'popUpCategory');
                    myDiv.setAttribute('id', 'pop-up-commented-code');
                    myDiv.innerHTML = 'The comment refers to a piece of code that is not used anymore';
                    document.body.appendChild(myDiv);
                }
            );

            $("#comment-code-button").mouseleave(function() {
                    $("#pop-up-commented-code").remove();
                }
            );

            //******************* Incomplete **********************
             $("#incomplete-button").mouseenter(function() {
                    var myDiv = document.createElement('div');
                    myDiv.setAttribute('class', 'popUpCategory');
                    myDiv.setAttribute('id', 'pop-up-incomplete');
                    myDiv.innerHTML = 'The comment is not completed';
                    document.body.appendChild(myDiv);
                }
            );

            $("#incomplete-button").mouseleave(function() {
                    $("#pop-up-incomplete").remove();
                }
            );

            //******************* New-Category **********************
             $("#new-category-button1").mouseenter(function() {
                    var myDiv = document.createElement('div');
                    myDiv.setAttribute('class', 'popUpCategory');
                    myDiv.setAttribute('id', 'pop-up-new-category');
                    myDiv.innerHTML = 'If none of the previous categories match the new comment-to-code association';
                    document.body.appendChild(myDiv);
                }
            );

            $("#new-category-button1").mouseleave(function() {
                    $("#pop-up-new-category").remove();
                }
            );


            /* --------------------------------------------------- */

            $("#toggleButton").click(function () {
               saveFlaggedClass();
            });





            //This instance need to be reviewed, therefore we start preparing the needed lists and the layout
            if (isLabeled == 1) {

                ShowNotification('Reviewing mode!', 'warning');
                $('#code').css('user-select', 'none');

                //Disable Save and Reset button until the user click on the first association
                $("#saveClassification").attr('disabled','disabled');
                $("#clearText").attr('disabled','disabled');

                //Update the badgeCounter
                counterAssociations = Number({{ counterAssociations }});
                $("#badgeCounter").text(counterAssociations);

                // Loading the lists
                dictHighlightedCommentsPosition = {{ artifact_label_commentPositionList | tojson }}
                {#dictRangeHighlightedCode = JSON.parse({{ artifact_label_rangeSelectedText | tojson }});#}
                dictSelectedCode = {{ selectedCode | tojson }};
                dictSelectedComment = {{ selectedComments | tojson }};
                dictSelectedCategories = {{ artificat_label_categories |tojson }};
                dictHighlightedCodeCharacterPosition = {{ codeSpan | tojson }}
                dictHighlightedCommentsCharacterPosition = {{ commentSpan | tojson  }}
                moveSelectionButtonList = {{ artifact_moveSelectionButtonList  |tojson }}

                var idsButton = [];
                for (var i = 0; i < 100; i++) {
                    try {
                        var doc = new DOMParser().parseFromString(moveSelectionButtonList[i], "text/xml");
                        var idButton = doc.getElementsByClassName("buttonWrapper")[0].id;
                        idsButton.push(idButton);
                        $("#lowerSide").append($(moveSelectionButtonList[i]));
                    }catch(ex){continue};
                }

                for (var i = 1; i < idsButton.length; i++) {
                    $("#" + idsButton[i].replace('div-', '')).attr('disabled', 'disabled');
                }

                $("#saveClassification").removeClass("btn-dark").addClass("btn-success").text("Accept");
                $("#clearText").removeClass("btn-dark").addClass("btn-warning").text("Change");

                $("#clearText").click(function () {
                   if(this.innerHTML.trim() === 'Change'){ this.innerHTML = 'Reset'; }
                });

            } else if (isLabeled == 0 && isReviewed == 0) {
                ShowNotification('Labeling mode!', 'warning');
            }

            $(".buttonWrapper").dblclick(function () {
                if(selectedCategories.length>=2){
                    alert('No more categories can be linked!');
                }else {
                    addNewCommentToBeLinked(this.childNodes[0].nextSibling)
                }
            });

            //Highlighting target comments
            var spanOfCharPerMethod = {{ artifact_methodsListBytes | tojson }}
                highlightTargetComments(comments, 'commentHighlighting', spanOfCharPerMethod);

            /*      If we find multi line comments written as single line
                    (E.G)
                    // read this item
                    // after send it
                    // to the server
             */

            $(".commentHighlighting").dblclick(function () {

                var prevElement = $(this).prev();
                var nextElement = $(this).next();

                var previousElements = [];
                var nextElements = [];

                var upperPartCommentSelection = '';
                var lowerPartCommentSelection = '';

                var currentElement = this;

                while (prevElement.hasClass('hljs-comment') && (currentElement.previousSibling.nodeType !== 3 || currentElement.previousSibling.textContent.trim() === '' && !commentWithin((currentElement.nextSibling.textContent.trim())))) {
                    if (!commentEleToHighlight.includes(prevElement)) {
                        previousElements.push(prevElement);
                    }
                    prevElement = $(prevElement).prev();
                    currentElement = currentElement.previousSibling;
                }

                //Adding current element selected by the user if it's not in the list already
                if (!commentEleToHighlight.includes($(this))) {
                    nextElements.push($(this));
                }

                currentElement = this;

                while (nextElement.hasClass("hljs-comment") && (currentElement.nextSibling.nodeType !== 3 || currentElement.nextSibling.textContent.trim() === '') && !commentWithin(currentElement.nextSibling.textContent.trim())) {

                    if (!commentEleToHighlight.includes(nextElement)) {
                        nextElements.push(nextElement);
                    }
                    nextElement = $(nextElement).next();
                    currentElement = currentElement.nextSibling;

                }

                for (var i = previousElements.length - 1; i >= 0; i--) {
                    upperPartCommentSelection = upperPartCommentSelection + previousElements[i][0].innerText + "\n";
                }

                for (var i = 0; i < nextElements.length; i++) {
                    lowerPartCommentSelection = lowerPartCommentSelection + nextElements[i][0].innerText + "\n";
                }

                //extending commentEleToHighlight
                var tmpArray = previousElements.reverse().concat(nextElements);
                for (var i = 0; i < tmpArray.length; i++) {
                    commentEleToHighlight.push(tmpArray[i]);
                }

                for (var i = 0; i < commentEleToHighlight.length; i++) {
                    if(isLabeled === 0 ) { $(commentEleToHighlight[i]).css('color', 'red').attr('id','comment-highlight-'+dictIndex); }
                    if(isLabeled === 1 ) { $(commentEleToHighlight[i]).css('color', 'red').attr('id','comment-highlight-'+currentClassification);}
                }

                var arr = Array.from(comments);

                for (var i = 0; i < commentEleToHighlight.length; i++) {
                    commentIndex.push(arr.indexOf(commentEleToHighlight[i][0]));
                }

                selectedCommentText = upperPartCommentSelection + lowerPartCommentSelection;
                var lines = selectedCommentText.split('\n');
                for (var k = 0; k < lines.length; k++) {
                    updateTextArea('<span class="selected-comment">' + lines[k] + '</span>');
                }

                selectedComments.push(selectedCommentText);
                beginningCommentCharacterPosition = fakeSelection4Comment(commentEleToHighlight[0][0]).start;
                endCommentCharacterPosition = fakeSelection4Comment(commentEleToHighlight[commentEleToHighlight.length - 1][0]).end;
                listSelectedSpanComment.push(beginningCommentCharacterPosition + '-' + endCommentCharacterPosition);

                unselectAll();

            });

            // Bind code are to "text select" events
            $('#code').bind('mouseup', function (event) {
                var code = document.getElementById("code");
                var sel = getSelectionCharOffsetsWithin(code);
                var start_point, stop_point, text_point, targetTag;

                if (sel.start === sel.end) {
                    start_point = 0;
                    stop_point = 0;
                    text_point = "";
                    targetTag = null;
                } else {
                    start_point = sel.start;
                    stop_point = sel.end;
                    text_point = sel.text;
                    targetTag = sel.targetTag;
                }

                if(!sel.text.trim().startsWith('//') && !sel.text.trim().startsWith('/*')) {
                    selectedCodeText = selectedCodeText + sel.text;
                }

                // If right side double selection is triggered
                try {
                    targetTag = targetTag.previousSibling;
                } catch (e) {
                }


                if (typeof (targetTag) != null && $(targetTag).hasClass('hljs-comment') && ( Math.abs(start_point-stop_point)<=3 )){

                    if (!commentEleToHighlight.includes($(targetTag))) {
                        commentEleToHighlight.push($(targetTag));
                    }
                    selectedCommentText = $(targetTag).text();
                    //$(targetTag).css('color', 'red').attr('id','comment-highlight-'+dictIndex);
                    if(isLabeled === 0 ) { $(targetTag).css('color', 'red').attr('id','comment-highlight-'+dictIndex); }
                    if(isLabeled === 1 ) { $(targetTag).css('color', 'red').attr('id','comment-highlight-'+currentClassification);}


                    updateTextArea('<span class="selected-comment">' + selectedCommentText + '</span>');
                    selectedComments.push(selectedCommentText);

                    beginningCommentCharacterPosition = fakeSelection4Comment(commentEleToHighlight[0][0]).start;
                    endCommentCharacterPosition = fakeSelection4Comment(commentEleToHighlight[commentEleToHighlight.length - 1][0]).end;

                    listSelectedSpanComment.push(beginningCommentCharacterPosition + '-' + endCommentCharacterPosition);

                    unselectAll();

                    var arr = Array.from(comments);
                    for (var i = 0; i < commentEleToHighlight.length; i++) {
                        commentIndex.push(arr.indexOf(commentEleToHighlight[i][0]));
                    }

                } else {
                    if (selectedCategory === '' && selectedCommentText === '' && text_point !== '' &&  !text_point.trim().startsWith('//') && !text_point.trim().startsWith('/*')) {
                        alert("Please select the comment first!");
                    } else {
                        if (selectedCommentText !== '' && selectedCategory === '' && text_point !== '') {
                            alert('Please select the comment category!');
                        } else {

                            if(!text_point.trim().startsWith('//') && !text_point.startsWith('/*') && stop_point>0 && stop_point > 0) {

                                var highlightedCodeNode = highlightRangeNew(start_point, stop_point);

                                const spanSelection = start_point + '-' + stop_point;
                                listSelectedSpanCode.push(spanSelection);
                                var lines = sel.text.split('\n');
                                for (var k = 0; k < lines.length; k++) {
                                    updateTextArea('<span class="selected-code">' + lines[k] + '</span>');
                                }

                                selectedCode.push(sel.text);
                                highlightedCodeDuringSelection.push(highlightedCodeNode);
                                unselectAll();

                            }
                        }
                    }

                }
                unselectAll();
                clicked = false;
            });

        });

        function submitClassification(){

            var newRefinedDict = getSameKeysDict(cleanDict(dictHighlightedCodeCharacterPosition), cleanDict(dictHighlightedCommentsCharacterPosition));

            if (confirm('Are you sure?')) {

                var data_json = {
                    artifact_id: {{  artifact_id }},
                    code: JSON.stringify(cleanDict(dictSelectedCode)),
                    comments: JSON.stringify(cleanDict(dictSelectedComment)),
                    categories: JSON.stringify(cleanDict(dictSelectedCategories)),
                    codeSpan: JSON.stringify(cleanDict(dictHighlightedCodeCharacterPosition)),
                    commentSpan: JSON.stringify(newRefinedDict),
                    commentPosition: JSON.stringify(cleanDict(dictHighlightedCommentsPosition)),
                    //rangeSelectedText: JSON.stringify(dictRangeHighlightedCode),
                    workingMode: workingMode,
                    moveToSelectedButtons: (isLabeled === 0 ? JSON.stringify(methodSelectionButton.filter(function(e){return e})) : JSON.stringify(moveSelectionButtonList.filter(function(e){return e}))),
                    counterAssociations: (isLabeled === 1 ?  Number({{ counterAssociations }}) : counterAssociations ),
                    duration:get_elapsed_seconds()
                };


                $.post("/label", data_json, function (response, status) {
                    let response_json = $.parseJSON(response.toString());
                    ShowNotification(response_json['status'], "success", 200);

                });

                //wait one second before moving on
                setTimeout(function(){
                    ChangeSkipToNext();
                },1000); //in millisecond



            }
        }

        function saveFlaggedClass(){
            if (confirm('Are you sure?')) {
                console.log('INN');
                var data_json = {artifact_id: {{  artifact_id }}};
                $.post("/flag", data_json, function (response, status) {
                    let response_json = $.parseJSON(response.toString());
                    ShowNotification(response_json['status'], "success", 200);
                });
            }
        }

     //handling new-category-selection if twice
     $(document).on('dblclick', '#new-category-button2', function () {
         if(selectedCategories.length>=2){
            alert('No more categories can be linked!');
        }else {
            addNewCommentToBeLinked(this.parentElement.childNodes[0]);
        }
     });

     $(document).on("mouseenter","#new-category-button2", function() {
         var myDiv = document.createElement('div');
         myDiv.setAttribute('class', 'popUpCategory');
         myDiv.setAttribute('id', 'pop-up-new-category');
         myDiv.innerHTML = 'If none of the previous categories match the new comment-to-code association';
         document.body.appendChild(myDiv);

     });

     $(document).on("mouseleave","#new-category-button2", function() { $("#pop-up-new-category").remove(); });


    </script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script src="{{ url_for('static', filename='js/notification.js') }}"></script>
    <script src="{{ url_for('static', filename='js/header.js') }}"></script>
    <script src="{{ url_for('static', filename='js/vendor/bootstrap-confirmation.min.js') }}"></script>

{% endblock %}