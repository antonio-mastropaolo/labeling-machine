{% extends "common_pages/common_layout.html" %}

{% block headerStuff %}
    <link href="https://cdn.jsdelivr.net/npm/highlightjs-themes@1.0.0/androidstudio.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
    <link href="{{ url_for('static', filename='css/artifact_common.css') }}" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlightjs-themes@1.0.0/github.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/highlight.min.js"></script>

    <script src="{{ url_for('static', filename='js/jquery.lettering-0.6.1.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/common-function.js') }}"></script>
    <script src="{{ url_for('static', filename='js/rangy-1.3.0/rangy-core.js') }}"></script>
    <script src="{{ url_for('static', filename='js/rangy-1.3.0/rangy-serializer.js') }}"></script>



    {#    High priority css classes#}
    <style>

        .category-button{}

        .commentHighlighting{
            background-color: yellow;
        }

        .selected-comment{
            color:yellow;
            display: block;
        }

        .selected-code{
            color:#FFE5CC;
            display: block;
        }


        .buttonWrapper{
            padding-bottom:7px;
            border-radius: 25px;
            padding-right: 5px;
            padding-left: 3px;
        }

        .animationLabel{
            animation:color-me-in 4s;
        }

       @keyframes color-me-in {
          /* You could think of as "step 1" */
          0% {
            background: red;
          }
          /* You could think of as "step 2" */
          100% {
            background: black;
          }
       }

       .popUpRefresh{
           border-style: solid;
           position:absolute;
           padding:2px;
           color:white;
           left:2.8%;
           top:85%;
       }

       .button-corner-down {
            position: fixed;
            bottom: 0.5%;
            text-align: center;
            background-color: black;
            left: 78%;
            width: 5%;
        }

        .button-corner-up {
            position: fixed;
            bottom: 7%;
            left: 78%;
            text-align: center;
            background-color: black;
            width: 5%;
        }

        .textarea {
            width:66.7%;
            overflow: hidden;
            overflow-y: scroll;
            bottom:0;
            height:11%;
            border-style: double;
            background-color: #404040;
            position:fixed;
            margin-bottom: -2px;
        }

        #code{
            margin-top:-2.44%;
        }

        @media screen and (max-height: 1250px) {
            #code{
              margin-top:-3.50%;
            }

            .textarea{
                bottom:0;
                height:10%;
            }


            .button-corner-down{
                bottom: 0.5%;
            }

            .button-corner-up{
                bottom: 5.5%;
            }

        }

        hr.solid {
            border-top: 3px solid #bbb;
        }


    </style>

{% endblock %}

<!-- Bootstrap container -->
 <div class="container">

    {% block content %}

        <div class="row no-gutters" style="background-color: black; padding-top: 10px;">

                 <div class=" col-md-4">
                    <div class="text-left">
                        <button class="btn btn-outline-info"
                            type="submit"
                            id="next-skip-btn"
                            onclick="skip_next_artifact()"
                            style="width: 100%;"> Skip
                        </button>
                    </div>

                 </div>

            <div class=" col-md-4">
                <div id="progress-bar" style="text-align: center; font-size: medium; color: white;">
                    {{ overall_labeling_status['n_artifacts_labeled'] }}
                    out of
                  {{ overall_labeling_status['n_total_artifacts'] }}
                </div>
                <div class="justify-content-center" style="display: flex;">
                    <div class="progress" style="width:50%;">
                        <div id="top-progress-bar-status" class="progress-bar" role="progressbar" style="width: 0%;"
                             aria-valuenow="0"
                             aria-valuemin="0"
                             aria-valuemax="100">
                        </div>
                    </div>
                </div>
            </div>

            <div class=" col-md-4">
                <div class="text-right">
                    <button class="btn btn-outline-success"
                            type="submit"
                            id="next-skip-btn"
                            onclick="submitClassifaction();"
                            style="width: 100%;"> Submit Classification
                    </button>
                </div>

            </div>

        </div>

        <div class="row no-gutters" style="background-color: black; height: 15px;">

            <div class=" col-md-12">
                <div class="" style="position: relative; padding-left: 20px;"></div>
            </div>

        </div>


        <div class="row no-gutters">

              <div class=" col-md-2 vh-100" style="background-color: black;">

                  <div class="buttonWrapper">
                      <button class="btn btn btn-dark category-button"
                        type="submit"
                        id="code-summary-button"
                        style="width: 100%" > Code Summary
                      </button>
                  </div>

                  <div class="buttonWrapper">
                      <button class="btn btn btn-dark category-button"
                        type="submit"
                        id="expand-button"
                        style="width: 100%" > Expand
                      </button>
                  </div>

                  <div class="buttonWrapper">
                      <button class="btn btn btn-dark category-button"
                        type="submit"
                        id="rationale-button"
                        style="width: 100%" > Rationale
                      </button>
                  </div>

                  <div class="buttonWrapper">
                      <button class="btn btn btn-dark category-button"
                        type="submit"
                        id="deprecation-button"
                        style="width: 100%" > Deprecation
                      </button>
                  </div>

                  <div class="buttonWrapper">
                      <button class="btn btn btn-dark category-button"
                        type="submit"
                        id="usage-button"
                        style="width: 100%" > Usage
                      </button>
                  </div>

                  <div class="buttonWrapper">
                      <button class="btn btn btn-dark category-button"
                        type="submit"
                        id="exception-button"
                        style="width: 100%" > Exception
                      </button>
                  </div>

                   <div class="buttonWrapper">
                      <button class="btn btn btn-dark category-button"
                        type="submit"
                        id="todo-button"
                        style="width: 100%" > TO-DO
                      </button>
                  </div>

                   <div class="buttonWrapper">
                      <button class="btn btn btn-dark category-button"
                        type="submit"
                        id="comment-code-button"
                        style="width: 100%" > Commented Code
                      </button>
                  </div>

                  <div class="buttonWrapper">
                      <button class="btn btn btn-dark category-button"
                        type="submit"
                        id="incomplete-button"
                        style="width: 100%" > Incomplete
                      </button>
                  </div>

                  <div class="buttonWrapper">
                      <button class="btn btn btn-dark category-button"
                        type="submit"
                        id="new-category-button"
                        style="width: 100%" > Define new category
                      </button>
                  </div>

                  <hr class="solid" style="position:relative; top:-15px;">

                  <hr class="solid" style="position:sticky; top:90.2%;">
                  <div id='refreshButton' style="position:fixed; left:6.5%; top:92%;" onclick="window.location.reload();">
                          <i class="far fa-trash-alt fa-4x" style="color:white;"></i>
                  </div>

              </div>


            <div class=" col-md-8 overflow-auto" id="codeColumn" style="height: 84.5vh;">

                <div class="row-column">

                    <pre id="rows-wrapper" class="rows">
                        <code id="rows" class="lang-java" style="display:inline; float:left; overflow: scroll;"></code>
                        <code id="code" class="lang-java">{{ artifact_class }}</code>
                    </pre>

                </div>

            </div>


            <div class=" col-md-2 no-float" id="methodsLabel" style="background-color: black;">

                <div id="upperSide" style="height: 40%;  position: absolute; width:100%; float:left; overflow-y: scroll;">
                    <!-- This Div is dyamically filled -->
                </div>

                <div id="divider" style="position: relative; top:38%; z-index:1000;">
                     <hr class="solid">
                         <div style="text-align: center; color: white;">
                             <h4 style="width:100%; position:relative;">ASSOCIATIONS</h4>
                             <span id="badgeCounter" class="badge badge-secondary" style="font-size:20px;">0</span>
                         </div>
                    <hr class="solid">
                </div>
                 <div id="lowerSide" style="height: 50%;  overflow-y: scroll; position:sticky;  top:90%; width:100%; float: left;">

                </div>
            </div>

        </div>

        <div class="row no-gutters">
            <div class=" col-md-2"></div>
            <div class=" col-md-8">
                <div contenteditable="true" id="textAreaSelectedText" rows="4" cols="50" class="textarea"></div>
                <button id="clearText" style="color:white;" type="submit" class='btn btn-dark button-corner-down' onclick="reset(); resetClicked=true;">Clear</button>
                <button id="savingClassification" type="submit" class='btn btn-dark button-corner-up' onclick="saveCategorization()">Save</button>
            </div>
            <div class=" col-md-2"></div>
        </div>

    {% endblock %}



 </div>


{% block scriptsStuff %}

    <script>

        // -------------------------Start-------------------------

        hljs.highlightAll();


        //updating progress bar
        var labelProgressPercentage = {{ overall_labeling_status['n_artifacts_labeled'] }}*100 / {{ overall_labeling_status['n_total_artifacts'] }};
        labelProgressPercentage = Math.ceil(labelProgressPercentage);
        document.getElementById("top-progress-bar-status").style.width = labelProgressPercentage + '%';
        document.getElementById("top-progress-bar-status").innerHTML = labelProgressPercentage + '%';

        const methodsList = {{ artifact_methodsListLines | tojson }};
        const methodsListNames = {{ artificat_methodsName | safe }};
        const linesList = {{ artificat_lines | tojson }};
        const isLabeled = {{ isLabeled }};
        const isReviewed = {{ isReviewed }};
        const workingMode = (isLabeled == 0 ? 0  : 1);

        var startTime = new Date().getTime();

        var labelCategories = ["new-category-button",
                                'expand-button',
                                'rationale-button',
                                'deprecation-button',
                                'usage-button',
                                'exception-button',
                                'todo-button',
                                'code-summary-button',
                                'comment-code-button',
                                'incomplete-button',
        ]

        var selectedCategory = "";
        var selectedCodeText = "";
        var selectedCommentText = "";
        var counterAssociations = 0;
        var currentIndexComment = -1;
        var whereCommentBegin = -1;
        var whereCommentEnd = -1;
        var resetClicked=false;
        var clicked = false;
        var currentClassification=-1;
        var defaultColorHighlight='red';
        var flagSwitch=true;
        var changingToClassificationOnGoing=false;

        var commentEleToHighlight = [];
        var highlightedCommentsInReviewing = [];

        var dictHighlightedCode = {};
        var dictHighlightedComments = {};
        var dictHighlightedCommentsPosition = {};
        //var dictRangeHighlightedCode = {};
        var dictHighlightedCommentsCharacterPosition = {};
        var dictHighlightedCodeCharacterPosition = {};
        var dictSelectedCategories = {};
        var dictSelectedCode = {};
        var dictSelectedComment = {};


        var comments = []; //In this list we store all the comments within a given class
        var selectedComments = [];
        var selectedCode = [];
        var serializedRangeList = []
        var listSelectedSpanCode = [];
        var listSelectedSpanComment = [];
        var selectedCategories = [];
        var commentsToHighlight = [];
        var methodSelectionButton = [];
        var moveSelectionButtonList = [];
        var highlightedCodeDuringSelection = []
        var commentIndex = [];
        var beginningCommentCharacterPosition = -1
        var endCommentCharacterPosition = -1

        // -------------------------End-------------------------

        $(document).ready(function () {


            $("h1").css('color', 'white');
            $("h2").css('color', 'white');
            $('.hljs-comment').css('user-select', 'none');

            // Filling up lines column
            for (var i = 0; i < linesList.length; i++) {
                linesList[i] = linesList[i] + 1
                var newButton = '<div style="width:100%;" class="row-line">' + linesList[i] + '</div>';
                $("#rows").append($(newButton));
            }

            for (var i = 0; i < methodsList.length; i++) {
                var buttonID = methodsListNames[i] + "-button";
                var startingLine = methodsList[i].split("-")[0];
                var buttonText = methodsListNames[i];// + " " +startingLine + '---' + endingLine;
                var scorllCall = 'moveToSelectedMethodFromLine(' + startingLine + ')';
                var newButton = '<div class="buttonWrapper style="display: flex; flex-direction:row;"> <button class="btn btn btn-dark" type="submit" id="' + buttonID + '" onclick="' + scorllCall + '" style="width: 100%; display:inline-flex; text-align: left;">' + buttonText + '</button> </div>';
                //console.log(newButton);
                $("#upperSide").append($(newButton));
            }

            comments = document.getElementsByClassName("hljs-comment");

            if (isLabeled == 0) {
                dictHighlightedCode[0] = [];
                //dictRangeHighlightedCode[0] = [];
                dictHighlightedCommentsPosition[0] = [];
            }

            $("#refreshButton").mouseenter(function() {
                    var myDiv = document.createElement('div');
                    myDiv.setAttribute('class', 'popUpRefresh');
                    myDiv.setAttribute('id', 'popUP');
                    myDiv.innerHTML = 'Remove all classifications!';
                    document.body.appendChild(myDiv);
                }
            );

            $("#refreshButton").mouseleave(function() {
                    $("#popUP").remove();
                }
            );

            //This instance need to be reviewed, therefore we start preparing the needed lists and the layout
            if (isLabeled == 1) {

                ShowNotification('Reviewing mode!', 'warning');

                //Update the badgeCounter
                counterAssociations = Number({{ counterAssociations }});
                $("#badgeCounter").text(counterAssociations);

                // Loading the lists
                dictHighlightedCommentsPosition = {{ artifact_label_commentPositionList | tojson }}
                {#dictRangeHighlightedCode = JSON.parse({{ artifact_label_rangeSelectedText | tojson }});#}
                dictSelectedCode = {{ selectedCode | tojson }};
                dictSelectedComment = {{ selectedComments | tojson }};
                dictSelectedCategories = {{ artificat_label_categories |tojson }};
                dictHighlightedCodeCharacterPosition = {{ codeSpan | tojson }}
                dictHighlightedCommentsCharacterPosition = {{ commentSpan | tojson  }}
                moveSelectionButtonList = {{ artifact_moveSelectionButtonList  |tojson }}

                var idsButton = [];
                for (var i = 0; i < moveSelectionButtonList.length; i++) {
                    if (dictHighlightedCommentsPosition[i].length == 0) {
                        continue;
                    }
                    var doc = new DOMParser().parseFromString(moveSelectionButtonList[i], "text/xml");
                    var idButton = doc.getElementsByClassName("buttonWrapper")[0].id;
                    idsButton.push(idButton);
                    $("#lowerSide").append($(moveSelectionButtonList[i]));
                }

                for (var i = 1; i < idsButton.length; i++) {
                    $("#" + idsButton[i].replace('div-', '')).attr('disabled', 'disabled');
                }

                $("#savingClassification").removeClass("btn-dark").addClass("btn-success").text("Accept");
                $("#clearText").removeClass("btn-dark").addClass("btn-warning").text("Change");

            } else if (isLabeled == 0 && isReviewed == 0) {
                ShowNotification('Labeling mode!', 'warning');
            }

            $(".buttonWrapper").dblclick(function () {
                var buttonID = this.childNodes[0].nextSibling.id;
                addNewCommentToBeLinked(this.childNodes[0].nextSibling)
            });

            //Highlighting target comments
            var spanOfCharPerMethod = {{ artifact_methodsListBytes | tojson }}
                highlightTargetComments(comments, 'commentHighlighting', spanOfCharPerMethod);

            /*      If we find multi line comments written as single line
                    (E.G)
                    // read this item
                    // after send it
                    // to the server
             */

            $(".commentHighlighting").dblclick(function () {

                var prevElement = $(this).prev();
                var nextElement = $(this).next();

                var previousElements = [];
                var nextElements = [];

                var upperPartCommentSelection = '';
                var lowerPartCommentSelection = '';

                var currentElement = this;

                while (prevElement.hasClass('hljs-comment') && (currentElement.previousSibling.nodeType !== 3 || currentElement.previousSibling.textContent.trim() === '' && !commentWithin((currentElement.nextSibling.textContent.trim())))) {
                    if (!commentEleToHighlight.includes(prevElement)) {
                        previousElements.push(prevElement);
                    }
                    prevElement = $(prevElement).prev();
                    currentElement = currentElement.previousSibling;
                }

                //Adding current element selected by the user if it's not in the list already
                if (!commentEleToHighlight.includes($(this))) {
                    nextElements.push($(this));
                }

                currentElement = this;

                while (nextElement.hasClass("hljs-comment") && (currentElement.nextSibling.nodeType !== 3 || currentElement.nextSibling.textContent.trim() === '') && !commentWithin(currentElement.nextSibling.textContent.trim())) {

                    if (!commentEleToHighlight.includes(nextElement)) {
                        nextElements.push(nextElement);
                    }
                    nextElement = $(nextElement).next();
                    currentElement = currentElement.nextSibling;

                }

                for (var i = previousElements.length - 1; i >= 0; i--) {
                    upperPartCommentSelection = upperPartCommentSelection + previousElements[i][0].innerText + "\n";
                }

                for (var i = 0; i < nextElements.length; i++) {
                    lowerPartCommentSelection = lowerPartCommentSelection + nextElements[i][0].innerText + "\n";
                }

                //extending commentEleToHighlight
                var tmpArray = previousElements.reverse().concat(nextElements);
                for (var i = 0; i < tmpArray.length; i++) {
                    commentEleToHighlight.push(tmpArray[i]);
                }

                for (var i = 0; i < commentEleToHighlight.length; i++) {
                    $(commentEleToHighlight[i]).css('color', 'red');
                }

                var arr = Array.from(comments);

                for (var i = 0; i < commentEleToHighlight.length; i++) {
                    commentIndex.push(arr.indexOf(commentEleToHighlight[i][0]));
                }

                selectedCommentText = upperPartCommentSelection + lowerPartCommentSelection;
                var lines = selectedCommentText.split('\n');
                for (var k = 0; k < lines.length; k++) {
                    updateTextArea('<span class="selected-comment">' + lines[k] + '</span>');
                }

                beginningCommentCharacterPosition = fakeSelection4Comment(commentEleToHighlight[0][0]).start;
                endCommentCharacterPosition = fakeSelection4Comment(commentEleToHighlight[commentEleToHighlight.length - 1][0]).end;
                listSelectedSpanComment.push(beginningCommentCharacterPosition + '-' + endCommentCharacterPosition);

                unselectAll();

            });

            // Bind code are to "text select" events
            $('#code').bind('mouseup', function (event) {
                var code = document.getElementById("code");
                var sel = getSelectionCharOffsetsWithin(code);
                var start_point, stop_point, text_point, targetTag;

                if (sel.start === sel.end) {
                    start_point = 0;
                    stop_point = 0;
                    text_point = "";
                    targetTag = null;
                } else {
                    start_point = sel.start;
                    stop_point = sel.end;
                    text_point = sel.text;
                    targetTag = sel.targetTag;
                }


                selectedCodeText = selectedCodeText + sel.text;
                // If right side double selection is triggered
                try {
                    targetTag = targetTag.previousSibling;
                } catch (e) {
                }

                //console.log(targetTag);

                if (typeof (targetTag) != null && $(targetTag).hasClass('hljs-comment') && ( Math.abs(start_point-stop_point)<=3 )){

                    if (!commentEleToHighlight.includes($(targetTag))) {
                        commentEleToHighlight.push($(targetTag));
                    }
                    selectedCommentText = $(targetTag).text();
                    $(targetTag).css('color', 'red');

                    updateTextArea('<span class="selected-comment">' + selectedCommentText + '</span>');

                    beginningCommentCharacterPosition = fakeSelection4Comment(commentEleToHighlight[0][0]).start;
                    endCommentCharacterPosition = fakeSelection4Comment(commentEleToHighlight[commentEleToHighlight.length - 1][0]).end;

                    listSelectedSpanComment.push(beginningCommentCharacterPosition + '-' + endCommentCharacterPosition);

                    unselectAll();

                    var arr = Array.from(comments);
                    for (var i = 0; i < commentEleToHighlight.length; i++) {
                        commentIndex.push(arr.indexOf(commentEleToHighlight[i][0]));
                    }

                } else {
                    if (selectedCategory === '' && selectedCommentText === '' && text_point !== '' &&  !text_point.trim().startsWith('//') && !text_point.trim().startsWith('/*')) {
                        alert("Please select the comment first!");
                    } else {
                        if (selectedCommentText !== '' && selectedCategory === '' && text_point !== '') {
                            alert('Please select the comment category!');
                        } else {

                            if(!text_point.trim().startsWith('//') && !text_point.startsWith('/*')) {

                                //old highlighting!
                                //Adding highlighting with span token and serialize range
                                //var newNode = highlightCodeFromRange(sel.range);
                                //var newNode = null;

                                //Adding new elements to the list
                                //highlightedCodeDuringSelection.push(newNode);
                                //serializedRangeList.push(sel.serializedRange);

                                highlightRangeNew(start_point, stop_point);

                                const spanSelection = start_point + '-' + stop_point;
                                listSelectedSpanCode.push(spanSelection);

                                var lines = sel.text.split('\n');
                                for (var k = 0; k < lines.length; k++) {
                                    updateTextArea('<span class="selected-code">' + lines[k] + '</span>');
                                }

                                unselectAll();

                            }
                        }
                    }

                }
                unselectAll();
                clicked = false;
            });

        });

        //Add here a for loop over counterAssociation
        function submitClassifaction(){

            if (confirm('Are you sure?')) { //implement control

                // for a better handling of the front end we save only one row in the database for each labeling process
                var data_json = {
                    artifact_id: {{  artifact_id }},
                    code: JSON.stringify(dictSelectedCode),
                    comments: JSON.stringify(dictSelectedComment),
                    categories: JSON.stringify(dictSelectedCategories),
                    codeSpan: JSON.stringify(dictHighlightedCodeCharacterPosition),
                    commentSpan: JSON.stringify(dictHighlightedCommentsCharacterPosition),
                    //rangeSelectedText: JSON.stringify(dictRangeHighlightedCode),
                    workingMode: workingMode,
                    moveToSelectedButtons: (isLabeled === 0 ? JSON.stringify(methodSelectionButton) : JSON.stringify(moveSelectionButtonList)),
                    commentPosition: JSON.stringify(dictHighlightedCommentsPosition),
                    counterAssociations: (isLabeled === 1 ?  Number({{ counterAssociations }}) : counterAssociations ),
                    duration:get_elapsed_seconds()
                };


                $.post("/label", data_json, function (response, status) {
                    let response_json = $.parseJSON(response.toString());
                    ShowNotification(response_json['status'], "success", 200);

                });

                //wait two seconds before moving on
                /*setTimeout(function(){
                    ChangeSkipToNext();
                },1000);*/
            }
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script src="{{ url_for('static', filename='js/notification.js') }}"></script>
    <script src="{{ url_for('static', filename='js/header.js') }}"></script>
    <script src="{{ url_for('static', filename='js/vendor/bootstrap-confirmation.min.js') }}"></script>
{% endblock %}