{% extends "common_pages/common_layout.html" %}

{% block headerStuff %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/code.css') }}" rel="stylesheet" type="text/css">
    <link href="{{ url_for('static', filename='css/artifact_common.css') }}" rel="stylesheet" type="text/css">
    <link rel="stylesheet"
          href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/styles/default.min.css">

    {#    High priority css classes#}
    <style>
        .category-button{}

        .buttonWrapper{
            padding-bottom:7px;
            border-radius: 25px;
            padding-right: 5px;
            padding-left: 3px;
        }

        .animationLabel{
            animation:color-me-in 5s;
        }

       @keyframes color-me-in {
          /* You could think of as "step 1" */
          0% {
            background: red;
          }
          /* You could think of as "step 2" */
          100% {
            background: black;
          }
       }

       .button-corner-down {
            position: absolute;
            bottom: 10%;
            left: 94.5%;
            width: 5%;
            text-align: justify;
        }

        .button-corner-up {
            position: absolute;
            bottom: 80%;
            left: 94.5%;
            width: 5%;
            text-align: justify;
        }

        .force-select {
          -webkit-user-select: all;  /* Chrome 49+ */
          -moz-user-select: all;     /* Firefox 43+ */
          -ms-user-select: all;      /* No support yet */
          user-select: all;          /* Likely future */
        }



    </style>

{% endblock %}

<!-- Bootstrap container -->
 <div class="container">

        {% block content %}

            <div class="row no-gutters" style="background-color: black; padding-top: 10px;">

                     <div class="col-lg-4">
                        <div class="text-left">
                            <button class="btn btn-outline-info"
                                    type="submit"
                                    id="interestingBtn"#}
                                    onclick="ToggleInterestingBtn({{ artifact_id }})"
                                    style="width: 100%;"> Interesting (?)
                            </button>
                        </div>

                     </div>

                <div class="col-lg-4">
                    <div style="text-align: center; font-size: medium; color: white;">
                        {{ overall_labeling_status['n_artifacts_labeled'] }}
                        out of
                        {{ overall_labeling_status['n_artifacts_to_be_labeled'] }} | <em>{{ overall_labeling_status['source_name'] }}</em>
                    </div>
                    <div class="justify-content-center" style="display: flex;">
                        <div class="progress" style="width:50%;">
                            <div id="top-progress-bar-status" class="progress-bar" role="progressbar" style="width: 0%; "
                                 aria-valuenow="0"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="text-right">
                        <button class="btn btn-outline-success"
                                type="submit"
                                id="next-skip-btn"
                                onclick="skip_next_artifact()"
                                style="width: 100%;"> Skip
                        </button>
                    </div>

                </div>

            </div>

            <div class="row no-gutters" style="background-color: black; height: 15px;">

                <div class="col-lg-12">
                    <div class="" style="position: relative; padding-left: 20px;"></div>
                </div>

            </div>


            <div class="row no-gutters">

                  <div class="col-lg-2 vh-100" style="background-color: black;">

                      <div class="buttonWrapper">
                          <button class="btn btn btn-dark category-button"
                            type="submit"
                            id="code-summary-button"
                            onclick="addNewCommentToBeLinked(this);"
                            style="width: 100%" > Code Summary
                          </button>
                      </div>

                      <div class="buttonWrapper">
                          <button class="btn btn btn-dark category-button"
                            type="submit"
                            id="expand-button"
                            onclick="addNewCommentToBeLinked(this);"
                            style="width: 100%" > Expand
                          </button>
                      </div>

                      <div class="buttonWrapper">
                          <button class="btn btn btn-dark category-button"
                            type="submit"
                            id="rationale-button"
                            onclick="addNewCommentToBeLinked(this);"
                            style="width: 100%" > Rationale
                          </button>
                      </div>

                      <div class="buttonWrapper">
                          <button class="btn btn btn-dark category-button"
                            type="submit"
                            id="deprecation-button"
                            onclick="addNewCommentToBeLinked(this);"
                            style="width: 100%" > Deprecation
                          </button>
                      </div>

                      <div class="buttonWrapper">
                          <button class="btn btn btn-dark category-button"
                            type="submit"
                            id="usage-button"
                            onclick="addNewCommentToBeLinked(this);"
                            style="width: 100%" > Usage
                          </button>
                      </div>

                      <div class="buttonWrapper">
                          <button class="btn btn btn-dark category-button"
                            type="submit"
                            id="exception-button"
                            onclick="addNewCommentToBeLinked(this);"
                            style="width: 100%" > Exception
                          </button>
                      </div>

                       <div class="buttonWrapper">
                          <button class="btn btn btn-dark category-button"
                            type="submit"
                            id="todo-button"
                            onclick="addNewCommentToBeLinked(this);"
                            style="width: 100%" > TO-DO
                          </button>
                      </div>

                       <div class="buttonWrapper">
                          <button class="btn btn btn-dark category-button"
                            type="submit"
                            id="comment-code-button"
                            onclick="addNewCommentToBeLinked(this);"
                            style="width: 100%" > Commented Code
                          </button>
                      </div>

                      <div class="buttonWrapper">
                          <button class="btn btn btn-dark category-button"
                            type="submit"
                            id="incomplete-button"
                            onclick="addNewCommentToBeLinked(this);"
                            style="width: 100%" > Incomplete
                          </button>
                      </div>

                      <div class="buttonWrapper">
                          <button class="btn btn btn-dark category-button"
                            type="submit"
                            id="new-category-button"
                            onclick="addNewCommentToBeLinked(this);"
                            style="width: 100%" > Define new category
                          </button>
                      </div>

                  </div>

                <div class="col-lg-8 overflow-auto" id="codeColumn" style="height: 84.5vh;">

                    <div style="overflow-y: scroll;">
                        {% highlight 'java', lineno='inline' %}
                            {{ artifact_class }}
                        {% endhighlight %}
                    </div>

                    <div id="selectedText" style="left: 0; bottom:0; width:100%; position: sticky;">
                         <textarea id="textAreaSelectedText" rows="5" cols="50" style="width: 100%; margin-top: -15px; padding-bottom:5px; overflow-y: scroll;"></textarea>
                         <button id="clearText" type="submit" class='btn btn-dark button-corner-down' onclick="resetHighlightedText()">Clear</button>
                         <button id="savingClassification" type="submit" class='btn btn-dark button-corner-up' onclick="saveCategorization()">Save</button>

                    </div>


                </div>



                <div class="col-lg-2 no-float" id="methodsLabel" style="background-color: black;">


{#                   <!-- This Div is dyamically filled -->#}

                </div>

            </div>


        {% endblock %}


 </div>


{% block scriptsStuff %}

    <script>

        // -------------------------Start-------------------------
        //console.log(window.getSelection().toString());
        //Newly defined functions

        var labelCategories = ["new-category-button",
                                'expand-button',
                                'rationale-button',
                                'deprecation-button',
                                'usage-button',
                                'exception-button',
                                'todo-button',
                                'code-summary-button',
                                'comment-code-button',
                                'incomplete-button',
        ]

        var selectedLines = [];

        var selectedCateory = "";
        var selectedCodeText = "";
        var selectedCommentText = "";
        var elementsToHighlight = [];


        var selectableSpanElements = document.getElementsByTagName("span");
        for (var i=8; i<selectableSpanElements.length; i++){
            if (!selectableSpanElements[i].classList.contains("linenos")){
                $(selectableSpanElements[i]).addClass('.force-select');
                //$(selectableSpanElements[i]).css('line-height','0');
            }
        }

        function resetHighlightedText(){

            for(var i=0; i<elementsToHighlight.length; i++){
                console.log('reset');
                $(elementsToHighlight[i]).css('background-color','');
                //$(siblings[j]).css('background-color','blue');
            }

            $("#textAreaSelectedText").text("");
            $('.category-button').css("background-color",'');
            $("#new-category-button").text("Define New Category");
            selectedLines = [];
            selectedCateory = "";
            selectedCodeText = "";
            selectedCommentText = "";
            elementsToHighlight = [];


        }



        function moveToSelectedMethod(startingLine, endingLine) {
            //console.log(startingLine + ' ------ ' + endingLine);
            var selector = 'span:contains(' + startingLine + ')';
            $(selector)[0].scrollIntoViewIfNeeded();

            $(selector).addClass('animationLabel').delay(1500).queue(function(){
                $(this).removeClass('animationLabel').dequeue();
            });


        }

        var mappingDict = {};
        var tags = document.getElementsByTagName("span");
        var key = -1;
        var flagChange = true;
        var elementsPerRow = [];
        //var finalLine = "";
        for (var i = 8; i < tags.length; i++) {

            if (tags[i].classList.contains("linenos")){

                key = tags[i].innerHTML;
                mappingDict[key] = "";
                flagChange = false;
                continue;
            }
            if (!flagChange){
                mappingDict[key] = mappingDict[key] + " " + tags[i].innerHTML;

            }

        }

        function checkForButtonValidity(){
            let textBoxVal = $("#textAreaSelectedText").val();
            if(textBoxVal=="") {
                alert("Select a comment first!");
                return false;
            }
            return true;
        }

         function popUP() {
            var newCategory = prompt("","Text");
            $("#new-category-button").text(newCategory);
        }

        function checkForChangedCategory(element){
            function arrayRemove(arr, value) {

                    return arr.filter(function(ele){
                        return ele != value;
                    });
                }
            var refinedCategories = arrayRemove(labelCategories, element.id.toString());

            for(var i=0;i<refinedCategories.length;i++){
                var selector="#"+refinedCategories[i];
                $(selector).css('background-color','');
            }

        }

        function addNewCommentToBeLinked(element){
            var retCode=checkForButtonValidity();
            if (!retCode) { return false;}
            checkForChangedCategory(element);
            if(element.id.toString()=="new-category-button"){
                popUP();
            }
            $(element).css('background-color','green');
            selectedCateory = element.id.toString();
            selectedCommentText = $("#textAreaSelectedText").val();
        }

        function getLinkedSnippet(){
            if(selectedCateory==""){
                alert("First link the given comment to the snippet!");
                return false;
            }

        }


        function saveCategorization(){
            if (!getLinkedSnippet()){
                //save snippet
                var allSelection = $("#textAreaSelectedText").val().toString();
                selectedCodeText = allSelection.replace(selectedCommentText,'');

                //console.log(selectedCommentText);
                //console.log(selectedCodeText);

                getLineNumbers();

                // save this classification into the database

                $("#textAreaSelectedText").text("");
                for(var i=0;i<labelCategories.length;i++){
                    var selector="#"+labelCategories[i];
                    $(selector).css('background-color','');
                }
            }

        }

        function getFirstLineofSelection() {
            var node,selection;
            if (window.getSelection) {
              selection = getSelection();
              node = selection.anchorNode;
            }
            if (!node && document.selection) {
                selection = document.selection
                var range = selection.getRangeAt ? selection.getRangeAt(0) : selection.createRange();
                node = range.commonAncestorContainer ? range.commonAncestorContainer :
                       range.parentElement ? range.parentElement() : range.item(0);
            }

            return node.parentNode.previousSibling.previousSibling.textContent
        }

        function highlightSelection(lines,isReviewer=false){

            for(var i=0; i<lines.length;i++){

                var lineTarget = Number(lines[i]);
                var lineSelector = ".linenos:contains(" + (lineTarget) + ")";

                var siblings = $(lineSelector).nextAll();

                for(var j=0;j<siblings.length;j++){
                    if (siblings[j].innerHTML==lineTarget+1){
                        break;
                    }
                    else{
                        $(siblings[j]).css('background-color','blue');
                        if(!isReviewer){
                            elementsToHighlight.push(siblings[j]);
                        }
                    }
                }
            }
        }




        // -------------------------End-------------------------

        $(document).ready(function () {

            //$(".linenos").css('user-select','none');
            $(".linenos").on('mouseup', function(e) {
                e.preventDefault();
            });

            $("#textAreaSelectedText").keydown(function(e) {
               e.preventDefault();
               return false;
            });

            document.addEventListener('mouseup', event => {

                if(window.getSelection().toString().length){
                    var selection = window.getSelection()
                    var firstLineOfSelection = getFirstLineofSelection();
                    var selectedText = selection.toString().replace(/^\s*\d+\s/gm,"");
                    var lines = selectedText.split('\n');

                    console.log('--> ' + firstLineOfSelection);

                    selectedLines.push(Number(firstLineOfSelection));

                    for(var i=1;i<lines.length;i++){
                       selectedLines.push(Number(firstLineOfSelection)+i);
                    }

                     highlightSelection(selectedLines);

                    let previousSelection = $("#textAreaSelectedText").val();
                    if(previousSelection==""){
                        $("#textAreaSelectedText").text(previousSelection + selectedText);
                    }
                    else{
                        $("#textAreaSelectedText").text(previousSelection + "\n" + selectedText);
                    }
                    document.getSelection().removeAllRanges();
                    console.log(selectedLines);
            }
            });

            var classification = JSON.parse('{{ artifact_classification|tojson }}');
            console.log(classification);

            jQuery.each(classification, function(i, val) {
                const lines = val.toString().split(",");
                highlightSelection(lines,isReviewer=true);
            });

            // Dynamically adding button on the right panel
            const methodList = JSON.parse('{{ artifact_methodList | tojson }}');

            for (let i = 0; i < methodList.length; i++) {
              var buttonID = "method-button-"+i;
              var startingLine = methodList[i].split("-")[0];
              var endingLine = methodList[i].split("-")[1];
              var buttonText = "Method_"+i+" " +startingLine + '---' + endingLine;
              var scorllCall = 'moveToSelectedMethod(' + startingLine +',' + endingLine +')';
              var newButton = '<div class="buttonWrapper"> <button class="btn btn btn-dark" type="submit" id="' + buttonID + '" onclick="' + scorllCall + '" style="width: 100%">' + buttonText + '</button> </div>';
              //console.log(newButton);
              $( "#methodsLabel" ).append( $(newButton) );

            }

            ////////////////////////////////////////////////////

            $("h1").css('color','white');

            $("h2").css('color','white');


            {#Change rows label color to white#}
            $(".linenos").css('color','white');


            $(document.body).on("change","#label_selector",function(){
                if(this.value == "")
                    $("#submit_btn").attr('disabled', "");
                else
                    $("#submit_btn").removeAttr('disabled');
            });

            $("#submit_btn").click(function () {
                let data_json = {     artifact_id: {{  artifact_id }},
                                                labeling_data: $('#label_selector').val(),
                                                duration: get_elapsed_seconds()};
                {#let data = JSON.stringify(data_json);#}
                $.post("/label", data_json, function (response, status) {
                    let response_json = $.parseJSON(response.toString())
                    ShowNotification(response_json['status'], "success");
                    ChangeSkipToNext();
                });
            });

        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
    <script src="{{ url_for('static', filename='js/notification.js') }}"></script>
    <script src="{{ url_for('static', filename='js/header.js') }}"></script>
    <script src="{{ url_for('static', filename='js/vendor/bootstrap-confirmation.min.js') }}"></script>
{% endblock %}
